'use strict';(function(){CKEDITOR.plugins.add('filetools',{lang:'ca,cs,da,de,de-ch,en,eo,es,eu,fr,gl,id,it,ja,km,ko,ku,nb,nl,oc,pl,pt,pt-br,ru,sv,tr,ug,uk,zh,zh-cn',beforeInit:function(editor){editor.uploadRepository=new UploadRepository(editor);editor.on('fileUploadRequest',function(evt){var fileLoader=evt.data.fileLoader;fileLoader.xhr.open('POST',fileLoader.uploadUrl,true);evt.data.requestData.upload={file:fileLoader.file,name:fileLoader.fileName};},null,null,5);editor.on('fileUploadRequest',function(evt){var fileLoader=evt.data.fileLoader,$formData=new FormData(),requestData=evt.data.requestData;for(var name in requestData){var value=requestData[name];if(typeof value==='object'&&value.file){$formData.append(name,value.file,value.name);}
else{$formData.append(name,value);}}
$formData.append('ckCsrfToken',CKEDITOR.tools.getCsrfToken());fileLoader.xhr.send($formData);},null,null,999);editor.on('fileUploadResponse',function(evt){var fileLoader=evt.data.fileLoader,xhr=fileLoader.xhr,data=evt.data;try{var response=JSON.parse(xhr.responseText);if(response.error&&response.error.message){data.message=response.error.message;}
if(!response.uploaded){evt.cancel();}else{for(var i in response){data[i]=response[i];}}}catch(err){data.message=fileLoader.lang.filetools.responseError;CKEDITOR.warn('filetools-response-error',{responseText:xhr.responseText});evt.cancel();}},null,null,999);}});function UploadRepository(editor){this.editor=editor;this.loaders=[];}
UploadRepository.prototype={create:function(fileOrData,fileName){var id=this.loaders.length,loader=new FileLoader(this.editor,fileOrData,fileName);loader.id=id;this.loaders[id]=loader;this.fire('instanceCreated',loader);return loader;},isFinished:function(){for(var id=0;id<this.loaders.length;++id){if(!this.loaders[id].isFinished()){return false;}}
return true;}};function FileLoader(editor,fileOrData,fileName){var mimeParts,defaultFileName=editor.config.fileTools_defaultFileName;this.editor=editor;this.lang=editor.lang;if(typeof fileOrData==='string'){this.data=fileOrData;this.file=dataToFile(this.data);this.total=this.file.size;this.loaded=this.total;}else{this.data=null;this.file=fileOrData;this.total=this.file.size;this.loaded=0;}
if(fileName){this.fileName=fileName;}else if(this.file.name){this.fileName=this.file.name;}else{mimeParts=this.file.type.split('/');if(defaultFileName){mimeParts[0]=defaultFileName;}
this.fileName=mimeParts.join('.');}
this.uploaded=0;this.uploadTotal=null;this.responseData=null;this.status='created';this.abort=function(){this.changeStatus('abort');};}
FileLoader.prototype={loadAndUpload:function(url,additionalRequestParameters){var loader=this;this.once('loaded',function(evt){evt.cancel();loader.once('update',function(evt){evt.cancel();},null,null,0);loader.upload(url,additionalRequestParameters);},null,null,0);this.load();},load:function(){var loader=this;this.reader=new FileReader();var reader=this.reader;loader.changeStatus('loading');this.abort=function(){loader.reader.abort();};reader.onabort=function(){loader.changeStatus('abort');};reader.onerror=function(){loader.message=loader.lang.filetools.loadError;loader.changeStatus('error');};reader.onprogress=function(evt){loader.loaded=evt.loaded;loader.update();};reader.onload=function(){loader.loaded=loader.total;loader.data=reader.result;loader.changeStatus('loaded');};reader.readAsDataURL(this.file);},upload:function(url,additionalRequestParameters){var requestData=additionalRequestParameters||{};if(!url){this.message=this.lang.filetools.noUrlError;this.changeStatus('error');}else{this.uploadUrl=url;this.xhr=new XMLHttpRequest();this.attachRequestListeners();if(this.editor.fire('fileUploadRequest',{fileLoader:this,requestData:requestData})){this.changeStatus('uploading');}}},attachRequestListeners:function(){var loader=this,xhr=this.xhr;loader.abort=function(){xhr.abort();onAbort();};xhr.onerror=onError;xhr.onabort=onAbort;if(xhr.upload){xhr.upload.onprogress=function(evt){if(evt.lengthComputable){if(!loader.uploadTotal){loader.uploadTotal=evt.total;}
loader.uploaded=evt.loaded;loader.update();}};xhr.upload.onerror=onError;xhr.upload.onabort=onAbort;}else{loader.uploadTotal=loader.total;loader.update();}
xhr.onload=function(){loader.update();if(loader.status=='abort'){return;}
loader.uploaded=loader.uploadTotal;if(xhr.status<200||xhr.status>299){loader.message=loader.lang.filetools['httpError'+xhr.status];if(!loader.message){loader.message=loader.lang.filetools.httpError.replace('%1',xhr.status);}
loader.changeStatus('error');}else{var data={fileLoader:loader},valuesToCopy=['message','fileName','url'],success=loader.editor.fire('fileUploadResponse',data);for(var i=0;i<valuesToCopy.length;i++){var key=valuesToCopy[i];if(typeof data[key]==='string'){loader[key]=data[key];}}
loader.responseData=data;delete loader.responseData.fileLoader;if(success===false){loader.changeStatus('error');}else{loader.changeStatus('uploaded');}}};function onError(){if(loader.status=='error'){return;}
loader.message=loader.lang.filetools.networkError;loader.changeStatus('error');}
function onAbort(){if(loader.status=='abort'){return;}
loader.changeStatus('abort');}},changeStatus:function(newStatus){this.status=newStatus;if(newStatus=='error'||newStatus=='abort'||newStatus=='loaded'||newStatus=='uploaded'){this.abort=function(){};}
this.fire(newStatus);this.update();},update:function(){this.fire('update');},isFinished:function(){return!!this.status.match(/^(?:loaded|uploaded|error|abort)$/);}};CKEDITOR.event.implementOn(UploadRepository.prototype);CKEDITOR.event.implementOn(FileLoader.prototype);var base64HeaderRegExp=/^data:(\S*?);base64,/;function dataToFile(data){var contentType=data.match(base64HeaderRegExp)[1],base64Data=data.replace(base64HeaderRegExp,''),byteCharacters=atob(base64Data),byteArrays=[],sliceSize=512,offset,slice,byteNumbers,i,byteArray;for(offset=0;offset<byteCharacters.length;offset+=sliceSize){slice=byteCharacters.slice(offset,offset+sliceSize);byteNumbers=new Array(slice.length);for(i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i);}
byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray);}
return new Blob(byteArrays,{type:contentType});}
if(!CKEDITOR.fileTools){CKEDITOR.fileTools={};}
CKEDITOR.tools.extend(CKEDITOR.fileTools,{uploadRepository:UploadRepository,fileLoader:FileLoader,getUploadUrl:function(config,type){var capitalize=CKEDITOR.tools.capitalize;if(type&&config[type+'UploadUrl']){return config[type+'UploadUrl'];}else if(config.uploadUrl){return config.uploadUrl;}else if(type&&config['filebrowser'+capitalize(type,1)+'UploadUrl']){return config['filebrowser'+capitalize(type,1)+'UploadUrl']+'&responseType=json';}else if(config.filebrowserUploadUrl){return config.filebrowserUploadUrl+'&responseType=json';}
return null;},isTypeSupported:function(file,supportedTypes){return!!file.type.match(supportedTypes);}});})();